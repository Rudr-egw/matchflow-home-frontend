<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MatchFlow Home - Request</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@600;700&family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --navy:#e8eef9;
      --teal:#1aa6a0;
      --orange:#f26c24;
      --cream:#0b1220;
      --paper:#0b1220;
      --text:#e6edf7;
      --muted:#a5b1c7;
      --line: rgba(255,255,255,.12);
      --shadow: 0 30px 80px rgba(0,0,0,.55);
      --panel: rgba(12,18,30,.92);
      --panelSoft: rgba(12,18,30,.78);
      --r: 20px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 5% 0%, rgba(26,166,160,.20), transparent 60%),
        radial-gradient(900px 600px at 95% 12%, rgba(242,108,36,.16), transparent 62%),
        linear-gradient(180deg, #05070d 0%, #0b1220 100%);
      color:var(--text);
      font-family: "Manrope", "Segoe UI", Arial, sans-serif;
      overflow:hidden;
    }

    .top{
      height:70px;
      padding:0 18px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line);
      background: rgba(8,12,20,.85);
      position:sticky; top:0;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:0}
    .logoImg{width:34px;height:34px; flex:0 0 auto;}
    .brandTxt{min-width:0}
    .brandTxt b{display:block; font-size:14px; letter-spacing:.2px}
    .brandTxt span{
      display:block; font-size:12px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 52ch;
    }
    .nav{display:flex; align-items:center; gap:10px;}
    .link{
      color: var(--text);
      text-decoration:none;
      font-size:13px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      transition: transform .12s ease, background .12s ease;
      white-space:nowrap;
    }
    .link:hover{transform: translateY(-1px); background: rgba(255,255,255,.10)}

    .layout{
      height: calc(100% - 70px);
      display:grid;
      grid-template-columns: 1fr 360px;
      grid-template-areas: "right left";
      gap:14px;
      padding:14px;
    }
    @media (max-width: 980px){
      body{overflow:auto}
      .layout{
        grid-template-columns:1fr;
        grid-template-areas: "right" "left";
        height:auto;
        padding-bottom:24px;
      }
    }

    .panel{
      border-radius: var(--r);
      border:1px solid var(--line);
      background: var(--panel);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    /* Left */
    .left{padding:16px; grid-area:left;}
    .left h3{margin:0 0 10px; font-size:13px; letter-spacing:.2px; color:var(--text)}
    .how{display:grid; gap:10px;}
    .item{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius:18px;
      padding:12px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .tick{
      width:18px;height:18px;border-radius:7px;
      background: rgba(26,166,160,.16);
      border:1px solid rgba(26,166,160,.4);
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
      margin-top:1px;
      font-weight:900;
      color: var(--teal);
      font-size:12px;
    }
    .item b{display:block; font-size:13px; margin-bottom:2px; color:var(--text)}
    .item span{display:block; font-size:12px; color:var(--muted); line-height:1.35}

    .tip{
      margin-top:12px;
      padding:12px 12px;
      border-radius:18px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-size:12px;
      line-height:1.45;
    }

    /* Right chat */
    .right{display:flex; flex-direction:column; min-height: 560px; height:100%; grid-area:right;}

    .chatTop{
      padding:14px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background: var(--panelSoft);
    }
    .stepWrap b{display:block; font-size:13px; color:var(--text)}
    .stepWrap span{display:block; font-size:12px; color:var(--muted); margin-top:2px}
    .progWrap{display:flex; align-items:center; gap:10px}
    .bar{
      width:190px; height:10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      overflow:hidden;
    }
    .fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--teal), var(--orange));
      border-radius:999px;
      transition: width .65s ease;
    }
    .pct{font-size:12px; color: var(--text); white-space:nowrap}

    .airtable-embed{
      width:100%;
      height:520px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
    }
    @media (max-width: 720px){
      .airtable-embed{height:700px;}
      .card{max-width:100%;}
      .chatTop{flex-direction:column; align-items:flex-start;}
      .progWrap{width:100%; justify-content:space-between;}
      .bar{width:100%;}
      .row{flex-direction:column; align-items:flex-start;}
      .row.user{align-items:flex-end;}
      .bubble{max-width:100%;}
      .btnRow{width:100%;}
      .btn{width:100%; justify-content:center;}
    }

    .chat{
      flex:1;
      padding:14px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      scroll-behavior:smooth;
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 25%);
    }
    .row{display:flex; gap:8px; align-items:flex-end; animation: pop .22s ease both;}
    @keyframes pop{from{transform:translateY(6px); opacity:0}to{transform:translateY(0); opacity:1}}
    .row.user{justify-content:flex-end}
    .avatar{
      width:30px;height:30px;border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      font-weight:900; font-size:11px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      flex:0 0 auto;
    }
    .avatar.bot{
      border-color: rgba(26,166,160,.3);
      background: rgba(26,166,160,.14);
      color: var(--teal);
    }
    .bubble{
      max-width: 78%;
      padding:12px 14px;
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(12,18,30,.92);
      line-height:1.35;
      font-size:13px;
      white-space:pre-wrap;
    }
    .row.user .bubble{
      background: rgba(26,166,160,.16);
      border-color: rgba(26,166,160,.25);
    }

    .typing{display:inline-flex; gap:6px; align-items:center;}
    .typing i{
      width:7px;height:7px;border-radius:50%;
      background: rgba(255,255,255,.6);
      display:inline-block;
      animation: bounce 1s infinite ease-in-out;
    }
    .typing i:nth-child(2){animation-delay:.12s}
    .typing i:nth-child(3){animation-delay:.24s}
    @keyframes bounce{0%,100%{transform:translateY(0); opacity:.55}50%{transform:translateY(-4px); opacity:1}}

    .card{
      width:100%;
      max-width:92%;
      border-radius:18px;
      border:1px solid var(--line);
      background: var(--panelSoft);
      padding:14px;
    }
    .card.full{max-width:100%;}
    .card h4{margin:0 0 6px; font-size:14px; color:var(--text)}
    .card p{margin:0 0 12px; font-size:12px; color:var(--muted); line-height:1.45}

    .btnRow{display:flex; gap:10px; flex-wrap:wrap;}
    .btn{
      cursor:pointer;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:11px 14px;
      border-radius:16px;
      font-weight:700;
      font-size:13px;
      transition: transform .12s ease, background .12s ease;
      user-select:none;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:9px;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.10)}
    .btn.primary{
      border:none;
      color:#fff;
      background: linear-gradient(135deg, var(--teal), var(--orange));
      box-shadow: 0 10px 24px rgba(26,166,160,.25);
    }
    .btn.warn{
      border-color: rgba(242,108,36,.35);
      background: rgba(242,108,36,.18);
      color: var(--text);
    }
    .btn[disabled]{opacity:.55; cursor:not-allowed; transform:none}

    .checkboxRow{
      display:flex; gap:10px; align-items:center;
      margin-top:8px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
    }

    /* Form */
    form{width:100%}
    label{display:block; font-size:12px; color:var(--text); margin:8px 0 4px}
    input, textarea, select{
      width:100%;
      background: rgba(12,18,30,.92);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      color:var(--text);
      outline:none;
      font-size:13px;
    }
    textarea{min-height:90px; resize:vertical}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}

    .sendStatus{
      display:none;
      align-items:center;
      gap:10px;
      margin-top:10px;
      font-size:12px;
      color: var(--muted);
    }
    .spin{
      width:16px;height:16px;border-radius:50%;
      border:2px solid rgba(11,27,59,.18);
      border-top-color: var(--teal);
      animation: spin .85s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>

<body>
  <header class="top">
    <div class="brand">
      <img class="logoImg" src="assets/logo.svg" alt="MatchFlow Home logo" />
      <div class="brandTxt">
        <b>MatchFlow Home</b>
        <span>Every homeowner's one-stop shop for local services</span>
      </div>
    </div>
    <nav class="nav">
      <a class="link" href="index.html">Home</a>
      <a class="link" href="about.html">About</a>
    </nav>
  </header>

  <div class="layout">
    <aside class="panel left">
      <h3>What happens next</h3>
      <div class="how">
        <div class="item">
          <div class="tick">&#10003;</div>
          <div><b>Upload photos</b><span>Optional, but it helps providers estimate more accurately.</span></div>
        </div>
        <div class="item">
          <div class="tick">&#10003;</div>
          <div><b>Submit your request</b><span>We collect the key details and start outreach.</span></div>
        </div>
        <div class="item">
          <div class="tick">&#10003;</div>
          <div><b>Three options</b><span>We aim to send three choices within 2-3 days.</span></div>
        </div>
      </div>

      <div class="tip">
        <b>Tip:</b> Use the same name and email on the form and the photo upload below so we can match everything.
      </div>
    </aside>

    <section class="panel right">
      <div class="chatTop">
        <div class="stepWrap">
          <b id="stepTitle">Step 1 of 2 - Photos</b>
          <span id="stepSub">Takes about 30-60 seconds.</span>
        </div>
        <div class="progWrap">
          <div class="bar"><div class="fill" id="fill"></div></div>
          <div class="pct" id="pct">0%</div>
        </div>
      </div>

      <div class="chat" id="chat"></div>
    </section>
  </div>

  <script>
    const FORMSPREE_ACTION = "https://formspree.io/f/mbdogolb";

    const chat = document.getElementById("chat");
    const stepTitle = document.getElementById("stepTitle");
    const stepSub = document.getElementById("stepSub");
    const fill = document.getElementById("fill");
    const pct = document.getElementById("pct");

    function scrollDown(){ chat.scrollTop = chat.scrollHeight; }
    function setProgress(p){
      const c = Math.max(0, Math.min(100, p));
      fill.style.width = c + "%";
      pct.textContent = c + "%";
    }

    function addMsg(text, who="bot", html=false){
      const row = document.createElement("div");
      row.className = "row " + (who === "user" ? "user" : "bot");

      const avatar = document.createElement("div");
      avatar.className = "avatar " + (who === "bot" ? "bot" : "");
      avatar.textContent = who === "bot" ? "MF" : "YOU";

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      if (html) bubble.innerHTML = text;
      else bubble.textContent = text;

      if (who === "user") { row.appendChild(bubble); row.appendChild(avatar); }
      else { row.appendChild(avatar); row.appendChild(bubble); }

      chat.appendChild(row);
      scrollDown();
      return bubble;
    }

    function addTyping(){
      const row = document.createElement("div");
      row.className = "row bot";
      const avatar = document.createElement("div");
      avatar.className = "avatar bot";
      avatar.textContent = "MF";
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = `<span class="typing"><i></i><i></i><i></i></span>`;
      row.appendChild(avatar);
      row.appendChild(bubble);
      chat.appendChild(row);
      scrollDown();
      return row;
    }
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    async function botSay(t){
      const k = addTyping();
      await sleep(1100);
      k.remove();
      addMsg(t, "bot");
    }

    // Simulated progress while they upload photos
    let timer = null;
    function startSimProgress(){
      clearInterval(timer);
      let p = 8;
      setProgress(p);
      timer = setInterval(() => {
        if (p < 86) p += Math.round((86 - p) * 0.12) + 1;
        setProgress(p);
      }, 700);
    }
    function finishProgress(){
      clearInterval(timer);
      setProgress(100);
    }

    function photoStep(){
      stepTitle.textContent = "Step 1 of 2 - Photos";
      stepSub.textContent = "Optional, but helps a lot.";
      setProgress(0);

      addMsg(`
        <div class="card full">
          <h4>Upload photos below</h4>
          <p>
            If you can, upload 1-5 photos (wide shot + close-up). It helps providers estimate faster and more accurately.
          </p>
          <iframe class="airtable-embed" src="https://airtable.com/embed/appJcERBxRVO7zsF7/pagLsogxeqrhWr6Sb/form" frameborder="0" onmousewheel="" width="100%" height="520" style="background: transparent; border: 1px solid var(--line);"></iframe>
          <div class="btnRow" style="margin-top:12px; justify-content:flex-end;">
            <button class="btn primary" id="continueBtn" type="button">Continue -></button>
          </div>
        </div>
      `, "bot", true);

      startSimProgress();

      const continueBtn = document.getElementById("continueBtn");
      continueBtn.addEventListener("click", async () => {
        finishProgress();
        addMsg("Continuing...", "user");
        await sleep(250);
        formStep();
      });
    }

    function formStep(){
      stepTitle.textContent = "Step 2 of 2 - Request";
      stepSub.textContent = "Quick form, then we start outreach.";
      setProgress(100);

      addMsg(`
        <div class="card">
          <h4>Request form</h4>
          <p>
            Fill this out and submit. Pricing is quote-based. Providers decide exact cost after reviewing your details.
          </p>

          <form id="requestForm" action="${FORMSPREE_ACTION}" method="POST">
            <div class="grid">
              <div>
                <label>Your name</label>
                <input name="name" required placeholder="Full name" />
              </div>
              <div>
                <label>Email</label>
                <input type="email" name="email" required placeholder="you@email.com" />
              </div>
            </div>

            <div class="grid">
              <div>
                <label>Phone</label>
                <input name="phone" required placeholder="(###) ###-####" />
              </div>
              <div>
                <label>ZIP</label>
                <input name="zip" required placeholder="30024" />
              </div>
            </div>

            <div class="grid">
              <div>
                <label>City</label>
                <input name="city" required placeholder="City" />
              </div>
              <div>
                <label>State</label>
                <input name="state" required placeholder="State" />
              </div>
            </div>

            <div class="grid">
              <div>
                <label>Service</label>
                <select name="service" id="serviceSelect" required>
                  <option value="" selected disabled>Select one</option>
                  <option>Plumbing</option>
                  <option>Electrical</option>
                  <option>HVAC</option>
                  <option>Handyman</option>
                  <option>Cleaning</option>
                  <option>Roofing</option>
                  <option>Landscaping</option>
                  <option>Pest Control</option>
                  <option>Painting</option>
                  <option>Moving</option>
                  <option>Car electronics (dashcam, backup camera, ambient lighting)</option>
                  <option>Car detailing (dents, scratches, paint, interior/exterior)</option>
                  <option>Caregiver Fast</option>
                </select>
              </div>
              <div>
                <label>Urgency</label>
                <select name="urgency" required>
                  <option value="" selected disabled>Select one</option>
                  <option>Emergency</option>
                  <option>Soon</option>
                  <option>Flexible</option>
                </select>
              </div>
            </div>

            <label>Budget range (approx.)</label>
            <div class="grid">
              <div>
                <label>Minimum budget</label>
                <input name="budget_min" type="number" min="0" placeholder="e.g., 500" />
              </div>
              <div>
                <label>Maximum budget</label>
                <input name="budget_max" type="number" min="0" placeholder="e.g., 2500" />
              </div>
            </div>
            <div class="checkboxRow" style="margin-top:8px;">
              <input id="budget_unknown" name="budget_unknown" type="checkbox" style="width:18px;height:18px; accent-color: var(--teal);" />
              <label for="budget_unknown" style="margin:0; font-size:12px; color:var(--text);">
                Not sure about budget
              </label>
            </div>

            <label>Describe what you need</label>
            <textarea name="message" required placeholder="Describe the issue, where it is, and anything important..."></textarea>

            <div id="carSection" style="display:none;">
              <label>Vehicle details</label>
              <div class="grid">
                <div>
                  <label>Make</label>
                  <input name="car_make" placeholder="Toyota" data-required="car" />
                </div>
                <div>
                  <label>Model & year</label>
                  <input name="car_model_year" placeholder="Camry 2020" data-required="car" />
                </div>
              </div>

              <label>Install type</label>
              <select name="car_install_type" data-required="car">
                <option value="" selected disabled>Select one</option>
                <option>Dashcam</option>
                <option>Backup camera</option>
                <option>Ambient lighting</option>
                <option>Multiple items</option>
              </select>

              <label>Preferred install timeframe</label>
              <select name="car_timeframe" data-required="car">
                <option value="" selected disabled>Select one</option>
                <option>As soon as possible</option>
                <option>This week</option>
                <option>Next 2-3 weeks</option>
                <option>Flexible</option>
              </select>
            </div>

            <div id="detailSection" style="display:none;">
              <label>Vehicle details</label>
              <div class="grid">
                <div>
                  <label>Make</label>
                  <input name="detail_make" placeholder="Toyota" data-required="detail" />
                </div>
                <div>
                  <label>Model & year</label>
                  <input name="detail_model_year" placeholder="Camry 2020" data-required="detail" />
                </div>
              </div>

              <label>Detailing goal</label>
              <select name="detail_goal" data-required="detail">
                <option value="" selected disabled>Select one</option>
                <option>Remove dents</option>
                <option>Fix scratches / paint issues</option>
                <option>Full exterior detail (restore shine)</option>
                <option>Interior deep clean</option>
                <option>Both interior and exterior</option>
                <option>Not sure - need advice</option>
              </select>

              <label>Damage / issue area</label>
              <select name="detail_area" data-required="detail">
                <option value="" selected disabled>Select one</option>
                <option>Front bumper / hood</option>
                <option>Side panels / doors</option>
                <option>Rear bumper / trunk</option>
                <option>Multiple areas</option>
                <option>Entire vehicle</option>
              </select>

              <label>Preferred timeframe</label>
              <select name="detail_timeframe" data-required="detail">
                <option value="" selected disabled>Select one</option>
                <option>As soon as possible</option>
                <option>This week</option>
                <option>Next 2-3 weeks</option>
                <option>Flexible</option>
              </select>
            </div>

            <div id="careSection" style="display:none;">
              <label>Care details</label>
              <div class="grid">
                <div>
                  <label>Care recipient age</label>
                  <input name="care_age" placeholder="Age" data-required="care" />
                </div>
                <div>
                  <label>Type of care</label>
                  <select name="care_type" data-required="care">
                    <option value="" selected disabled>Select one</option>
                    <option>Companionship</option>
                    <option>Mobility assistance</option>
                    <option>Personal care</option>
                    <option>Medication reminders</option>
                    <option>Multiple needs</option>
                  </select>
                </div>
              </div>

              <label>Schedule needed</label>
              <select name="care_schedule" data-required="care">
                <option value="" selected disabled>Select one</option>
                <option>Full time</option>
                <option>Part time</option>
                <option>Overnight</option>
                <option>Weekends</option>
                <option>Flexible</option>
              </select>

              <label>Where will care be provided?</label>
              <select name="care_location" data-required="care">
                <option value="" selected disabled>Select one</option>
                <option>In home</option>
                <option>Assisted living</option>
                <option>Other</option>
              </select>
            </div>

            <label>Privacy and consent</label>
            <div style="border:1px solid var(--line); background: rgba(11,27,59,.04); border-radius:14px; padding:12px; font-size:12px; color:var(--muted); line-height:1.45;">
              <b style="color:var(--text);">MatchFlow Home privacy and consent</b>
              <p style="margin:6px 0 0;">
                We do not sell your information. By submitting this form, you allow MatchFlow Home to share your
                request details, photos, and budget range with local businesses so they can decide if the job is a fit.
                If a business confirms they can take your request and you say yes, we will then connect you by sharing
                your contact details. After that, we step back and you work directly with the business.
              </p>
              <p style="margin:8px 0 0;">
                <a href="privacy.html" style="color:var(--text); text-decoration:none;">Read the full privacy policy</a>
              </p>
              <div style="margin-top:8px; display:flex; gap:10px; align-items:flex-start;">
                <input id="consent" name="consent" type="checkbox" required style="width:18px;height:18px; accent-color: var(--teal);" />
                <label for="consent" style="margin:0; font-size:12px; color:var(--text);">
                  I agree to the privacy and consent terms above.
                </label>
              </div>
            </div>

            <div style="margin-top:10px; color: var(--muted); font-size:12px; line-height:1.45;">
              <b>Note:</b> If you uploaded photos above, make sure you used the same name and email.
            </div>

            <div class="btnRow" style="justify-content:flex-end; margin-top:12px;">
              <button class="btn primary" id="submitBtn" type="submit">Submit -></button>
            </div>

            <div class="sendStatus" id="sendStatus">
              <span class="spin"></span>
              <span id="sendText">Sending your request...</span>
            </div>
          </form>
        </div>
      `, "bot", true);

      wireSubmit();
      wireDraftStorage();
      wireBudgetUnknown();
      wireServiceQuestions();
    }

    const DRAFT_KEY = "matchflow_form_draft_v2";

    function wireDraftStorage(){
      const form = document.getElementById("requestForm");
      if (!form) return;

      restoreDraft(form);

      form.addEventListener("input", () => saveDraft(form));
      form.addEventListener("change", () => saveDraft(form));
    }

    function saveDraft(form){
      const data = {};
      const fields = form.querySelectorAll("input, textarea, select");
      fields.forEach((el) => {
        if (!el.name) return;
        if (el.type === "checkbox") data[el.name] = el.checked;
        else data[el.name] = el.value;
      });
      localStorage.setItem(DRAFT_KEY, JSON.stringify(data));
    }

    function restoreDraft(form){
      const raw = localStorage.getItem(DRAFT_KEY);
      if (!raw) return;
      let data = {};
      try{ data = JSON.parse(raw) || {}; } catch(e){ return; }

      const serviceSelect = document.getElementById("serviceSelect");
      if (data.service && serviceSelect) {
        serviceSelect.value = data.service;
        serviceSelect.dispatchEvent(new Event("change"));
      }

      const fields = form.querySelectorAll("input, textarea, select");
      fields.forEach((el) => {
        if (!el.name || data[el.name] === undefined) return;
        if (el.type === "checkbox") el.checked = !!data[el.name];
        else el.value = data[el.name];
      });
    }

    function wireSubmit(){
      const form = document.getElementById("requestForm");
      const submitBtn = document.getElementById("submitBtn");
      const sendStatus = document.getElementById("sendStatus");
      const sendText = document.getElementById("sendText");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        submitBtn.disabled = true;
        submitBtn.textContent = "Sending...";
        sendStatus.style.display = "flex";
        sendText.textContent = "Sending your request...";

        const t = addTyping();

        try{
          const minEl = form.querySelector("[name='budget_min']");
          const maxEl = form.querySelector("[name='budget_max']");
          const unknownEl = form.querySelector("[name='budget_unknown']");
          const minVal = minEl ? minEl.value.trim() : "";
          const maxVal = maxEl ? maxEl.value.trim() : "";
          const isUnknown = unknownEl ? unknownEl.checked : false;

          if (!isUnknown && (!minVal || !maxVal)) {
            submitBtn.disabled = false;
            submitBtn.textContent = "Submit ->";
            sendStatus.style.display = "flex";
            sendText.textContent = "Please enter a minimum and maximum budget, or select Not sure.";
            return;
          }

          const fd = new FormData(form);
          fd.append("source", "MatchFlow Chat");
          fd.append("timestamp", new Date().toISOString());
          const res = await fetch(form.action, {
            method: "POST",
            body: fd,
            headers: { "Accept": "application/json" }
          });

          t.remove();

          if(res.ok){
            await botSay("Got it âœ“ We received your request.");
            await botSay("Sending you to a quick processing screen...");
            await sleep(650);
            window.location.href = "processing.html";
          } else {
            submitBtn.disabled = false;
            submitBtn.textContent = "Submit ->";
            sendText.textContent = "Something went wrong. Please try again.";
          }
        } catch(err){
          t.remove();
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit ->";
          sendText.textContent = "Network error. Please try again.";
        }
      });
    }

    function wireBudgetUnknown(){
      const minEl = document.querySelector("[name='budget_min']");
      const maxEl = document.querySelector("[name='budget_max']");
      const unknownEl = document.querySelector("[name='budget_unknown']");
      if (!minEl || !maxEl || !unknownEl) return;

      function sync(){
        const disabled = unknownEl.checked;
        minEl.disabled = disabled;
        maxEl.disabled = disabled;
        if (disabled) {
          minEl.value = "";
          maxEl.value = "";
        }
      }

      unknownEl.addEventListener("change", sync);
      sync();
    }

    function wireServiceQuestions(){
      const serviceSelect = document.getElementById("serviceSelect");
      const carSection = document.getElementById("carSection");
      const detailSection = document.getElementById("detailSection");
      const careSection = document.getElementById("careSection");
      if (!serviceSelect || !carSection || !detailSection || !careSection) return;

      function setRequired(section, on){
        const fields = section.querySelectorAll("[data-required]");
        fields.forEach((el) => {
          if (on) el.setAttribute("required", "required");
          else el.removeAttribute("required");
        });
      }

      function update(){
        const value = serviceSelect.value || "";
        const isCar = value.startsWith("Car electronics");
        const isDetail = value.startsWith("Car detailing");
        const isCare = value === "Caregiver Fast";

        carSection.style.display = isCar ? "block" : "none";
        detailSection.style.display = isDetail ? "block" : "none";
        careSection.style.display = isCare ? "block" : "none";
        setRequired(carSection, isCar);
        setRequired(detailSection, isDetail);
        setRequired(careSection, isCare);
      }

      serviceSelect.addEventListener("change", update);
      update();
    }

    (async function init(){
      if (sessionStorage.getItem("matchflow_chat_started")) return;
      sessionStorage.setItem("matchflow_chat_started", "1");
      await botSay("Hi, I am MatchFlow. I will guide you through this in under a minute.");
      await botSay("You will see two steps: a photo upload and a short request form.");
      await botSay("Photos are optional, but they help providers estimate faster.");
      await botSay("When you are ready, start with the upload section below.");
      await botSay("I will stay here and keep the progress moving.");
      photoStep();
    })();
  </script>
</body>
</html>
