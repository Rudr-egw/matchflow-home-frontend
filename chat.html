<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MatchFlow — Chat</title>

  <style>
    :root{
      --bg:#0b0b0f;
      --panel:#12121a;
      --line:#232334;
      --text:#f2f2f7;
      --muted:#9a9aaa;
      --accent:#6ea8ff;
      --good:#44d19d;
      --warn:#ffcc66;
      --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 650px at 50% 0%, #1a1a2a 0%, var(--bg) 55%),
        radial-gradient(900px 600px at 0% 100%, rgba(110,168,255,.10) 0%, transparent 60%),
        radial-gradient(900px 600px at 100% 100%, rgba(68,209,157,.08) 0%, transparent 60%),
        var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    /* Top bar */
    .topbar{
      border-bottom:1px solid var(--line);
      background:rgba(18,18,26,.75);
      backdrop-filter: blur(12px);
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900;
      letter-spacing:.01em;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 18px rgba(110,168,255,.8);
    }
    .sub{color:var(--muted); font-weight:700; font-size:12px; margin-top:2px;}
    .left{display:flex; flex-direction:column; gap:2px; min-width:0;}
    .right{display:flex; align-items:center; gap:10px; color:var(--muted); font-size:12px; font-weight:900;}
    .pill{
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .link{
      text-decoration:none;
      color:var(--muted);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:transparent;
      font-weight:900;
    }
    .link:hover{border-color:#2f2f4a}

    /* Main */
    .wrap{
      width:min(920px, 96vw);
      margin:0 auto;
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    .chat{
      flex:1;
      overflow:auto;
      padding:14px 14px 10px;
      display:flex;
      flex-direction:column;
      gap:12px;
      scroll-behavior:smooth;
    }

    /* Messages */
    .row{display:flex; gap:10px}
    .row.user{justify-content:flex-end}
    .bubble{
      max-width:min(760px, 94%);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px 14px;
      line-height:1.45;
      white-space:pre-wrap;
      background:rgba(0,0,0,.12);
      animation: popIn .18s ease-out;
    }
    .bubble.assistant{background:rgba(20,20,38,.88)}
    .bubble.user{background:rgba(26,26,42,.88)}
    @keyframes popIn{
      from{opacity:0; transform:translateY(6px) scale(.98)}
      to{opacity:1; transform:translateY(0) scale(1)}
    }

    /* Typing dots */
    .typing{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:2px 0;
    }
    .typing span{
      width:7px;height:7px;border-radius:999px;
      background:var(--muted);
      opacity:.45;
      animation:bounce 1s infinite;
    }
    .typing span:nth-child(2){animation-delay:.15s}
    .typing span:nth-child(3){animation-delay:.3s}
    @keyframes bounce{
      0%,100%{transform:translateY(0); opacity:.35}
      50%{transform:translateY(-4px); opacity:.9}
    }

    /* Chips */
    .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;}
    .chip{
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:9px 11px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      transition:.15s transform, .15s border, .15s background;
      user-select:none;
    }
    .chip:hover{
      transform: translateY(-1px);
      border-color:#2f2f4a;
      background:rgba(110,168,255,.08);
    }
    .chip.primary{
      border-color: rgba(110,168,255,.35);
      background: linear-gradient(180deg, rgba(110,168,255,.18), rgba(110,168,255,.06));
    }

    /* Matching card */
    .card{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      background:rgba(0,0,0,.16);
      overflow:hidden;
      position:relative;
    }
    .shimmer::before{
      content:"";
      position:absolute;
      top:-30%;
      left:-40%;
      width:60%;
      height:160%;
      background: linear-gradient(90deg, transparent, rgba(110,168,255,.18), transparent);
      transform: rotate(20deg);
      animation: shimmer 1.4s ease-in-out infinite;
    }
    @keyframes shimmer{
      from{transform: translateX(-30%) rotate(20deg)}
      to{transform: translateX(260%) rotate(20deg)}
    }
    .card strong{display:block; font-size:16px; margin-bottom:4px}
    .card small{color:var(--muted)}
    .meta{margin-top:10px; color:var(--muted); font-size:13px; line-height:1.55}

    /* Results list */
    .result{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      margin-top:10px;
      background:rgba(0,0,0,.14);
    }
    .resultTop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start;}
    .resultName{font-weight:1000; color:var(--text)}
    .resultBadge{
      font-size:12px;
      font-weight:1000;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(110,168,255,.35);
      background:linear-gradient(180deg, rgba(110,168,255,.16), rgba(110,168,255,.06));
      white-space:nowrap;
    }

    /* Composer */
    .composer{
      border-top:1px solid var(--line);
      background:rgba(18,18,26,.82);
      backdrop-filter: blur(12px);
      padding:12px 14px;
    }
    .composerInner{
      display:flex;
      gap:10px;
      align-items:center;
      width:min(920px, 96vw);
      margin:0 auto;
    }
    input{
      flex:1;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      color:var(--text);
      font-size:16px;
      outline:none;
      transition: border .15s;
    }
    input:focus{border-color: rgba(110,168,255,.35)}
    button{
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(110,168,255,.35);
      background:linear-gradient(180deg, rgba(110,168,255,.22), rgba(110,168,255,.08));
      color:var(--text);
      font-weight:1000;
      cursor:pointer;
      white-space:nowrap;
    }
    button:hover{filter:brightness(1.05)}
    .hint{
      color:var(--muted);
      font-size:12px;
      margin-top:8px;
      text-align:center;
    }

    /* disabled state */
    .disabled{opacity:.55; pointer-events:none}

    /* invalid shake */
    .shake{animation: shake .25s ease-in-out}
    @keyframes shake{
      0%{transform:translateX(0)}
      25%{transform:translateX(-6px)}
      50%{transform:translateX(6px)}
      75%{transform:translateX(-4px)}
      100%{transform:translateX(0)}
    }
    .warn{color: var(--warn)}
    .bad{color: var(--bad)}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="left">
      <div class="brand"><span class="dot"></span> MatchFlow Chat</div>
      <div class="sub">Answer a few questions — we’ll match 3 options.</div>
    </div>
    <div class="right">
      <span class="pill" id="progressPill">Question 1 of 8</span>
      <a class="link" href="index.html">Back</a>
    </div>
  </div>

  <div class="wrap">
    <div id="chat" class="chat"></div>
  </div>

  <div class="composer">
    <div class="composerInner">
      <input id="input" placeholder="Type your answer…" autocomplete="off" />
      <button id="send">Send</button>
    </div>
    <div class="hint" id="hint">Tip: use the chips for fast answers.</div>
  </div>

  <script>
    // =========================
    // CONFIG (SET THIS)
    // =========================
    const MATCH_API = "https://YOUR-VERCEL-PROJECT.vercel.app/api/match"; // <- change later

    // =========================
    // QUESTION FLOW
    // =========================
    const questions = [
      {
        key: "service",
        type: "select",
        text: "What service do you need?",
        options: [
          "Plumbing","Electrical","HVAC","House Cleaning","Handyman",
          "Lawn Care","Landscaping","Pest Control","Junk Removal","Moving",
          "Painting","Garage Door","Roofing","Appliance Repair","Pressure Washing",
          "Gutter Cleaning","Flooring","Tile","Drywall","Fence",
          "Windows","Doors","Pool Service","Irrigation","Locksmith"
        ]
      },
      { key: "zip", type: "zip", text: "What ZIP code is the service needed in? (5 digits)" },
      {
        key: "urgency",
        type: "select",
        text: "How urgent is this?",
        options: ["Emergency (today)","Urgent (1–2 days)","Soon (this week)","Flexible"]
      },
      {
        key: "budget",
        type: "select",
        text: "What budget range are you comfortable with?",
        options: [
          "$0–$50", "$50–$100", "$100–$150", "$150–$200",
          "$200–$300", "$300–$400", "$400–$500",
          "$500–$750", "$750–$1000", "$1000–$1500",
          "$1500–$2000", "$2000–$3000", "$3000–$5000", "$5000+"
        ]
      },
      { key: "details", type: "text", text: "Briefly describe what needs to be done (1 sentence)." },
      { key: "name", type: "name", text: "What’s your full name?" },
      { key: "email", type: "email", text: "What’s the best email to contact you?" },
      { key: "phone", type: "phone", text: "What’s the best phone number?" }
    ];

    // =========================
    // UI HELPERS
    // =========================
    const chatEl = document.getElementById("chat");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const progressPill = document.getElementById("progressPill");
    const hintEl = document.getElementById("hint");

    const state = { step: 0, answers: {} };

    function scrollToBottom(){ chatEl.scrollTop = chatEl.scrollHeight; }
    function typingDots(){ return `<span class="typing"><span></span><span></span><span></span></span>`; }

    function setProgress(){
      const n = Math.min(state.step + 1, questions.length);
      progressPill.textContent = `Question ${n} of ${questions.length}`;
    }

    function addBubble(role, html){
      const row = document.createElement("div");
      row.className = "row " + role;
      const bubble = document.createElement("div");
      bubble.className = "bubble " + role;
      bubble.innerHTML = html;
      row.appendChild(bubble);
      chatEl.appendChild(row);
      scrollToBottom();
      return bubble;
    }

    function renderChips(options){
      const chips = options.map((opt, idx) => {
        const cls = (idx < 4) ? "chip primary" : "chip";
        return `<button class="${cls}" data-chip="${opt}">${opt}</button>`;
      }).join("");
      return `<div class="chips">${chips}</div>`;
    }

    async function askAssistant(text, options=null){
      const bubble = addBubble("assistant", typingDots());
      await new Promise(r => setTimeout(r, 520));
      bubble.innerHTML = `<div>${text}</div>` + (options ? renderChips(options) : "");
      scrollToBottom();

      bubble.querySelectorAll("[data-chip]").forEach(btn => {
        btn.addEventListener("click", () => {
          inputEl.value = btn.getAttribute("data-chip");
          handleSend();
        });
      });
    }

    function lockComposer(locked){
      if (locked){
        inputEl.classList.add("disabled");
        sendBtn.classList.add("disabled");
        inputEl.disabled = true;
        sendBtn.disabled = true;
      } else {
        inputEl.classList.remove("disabled");
        sendBtn.classList.remove("disabled");
        inputEl.disabled = false;
        sendBtn.disabled = false;
      }
    }

    function showInvalid(msg){
      inputEl.classList.remove("shake");
      void inputEl.offsetWidth;
      inputEl.classList.add("shake");
      addBubble("assistant", `<span class="warn">⚠️ ${msg}</span>`);
    }

    // =========================
    // VALIDATION
    // =========================
    function validateEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v.trim()); }
    function validatePhone(v){
      const digits = v.replace(/\D/g,"");
      return digits.length >= 10 && digits.length <= 15;
    }
    function validateName(v){
      const s = v.trim();
      if (s.length < 2) return false;
      return /^[a-zA-Z][a-zA-Z\s\-']+$/.test(s);
    }

    function validateAnswer(q, raw){
      const value = (raw || "").trim();
      if (!value) return { ok:false, msg:"Please enter an answer." };

      if (q.type === "zip"){
        const z = value.replace(/\s+/g,"");
        if (!/^\d{5}$/.test(z)) return { ok:false, msg:"Enter a valid 5-digit ZIP (example: 30024)." };
        return { ok:true, value: z };
      }
      if (q.type === "email"){
        if (!validateEmail(value)) return { ok:false, msg:"Enter a valid email (example: name@gmail.com)." };
        return { ok:true, value: value.toLowerCase() };
      }
      if (q.type === "phone"){
        if (!validatePhone(value)) return { ok:false, msg:"Enter a valid phone number (10–15 digits)." };
        return { ok:true, value: value.replace(/\D/g,"") };
      }
      if (q.type === "name"){
        if (!validateName(value)) return { ok:false, msg:"Enter your full name (letters/spaces only)." };
        return { ok:true, value };
      }
      if (q.type === "text"){
        if (value.length < 10) return { ok:false, msg:"Add a bit more detail (at least ~10 characters)." };
        return { ok:true, value };
      }

      // select type: must be one of the options
      if (q.type === "select"){
        const ok = q.options.includes(value);
        if (!ok) return { ok:false, msg:"Please choose one of the provided options (tap a chip)." };
        return { ok:true, value };
      }

      return { ok:true, value };
    }

    function currentQuestion(){ return questions[state.step]; }

    // =========================
    // MATCHING ANIMATION + BACKEND CALL
    // =========================
    async function runMatching(){
      lockComposer(true);

      await askAssistant("Thanks — matching 3 best options for you now…");

      const anim = addBubble("assistant", `
        <div class="card shimmer">
          <strong>Matching…</strong>
          <small>Comparing service fit, price fit, and availability.</small>
          <div class="meta" style="margin-top:10px">
            • Checking service area<br>
            • Filtering by urgency<br>
            • Scoring providers by fit
          </div>
        </div>
      `);

      await new Promise(r => setTimeout(r, 1200));

      // Call backend for top 3 matches
      let matches = [];
      try {
        const res = await fetch(MATCH_API, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(state.answers)
        });

        if (!res.ok) throw new Error("Backend returned an error");
        const data = await res.json();
        matches = (data && data.matches) ? data.matches : [];
      } catch (e) {
        // Show graceful error if backend not ready yet
        anim.innerHTML = `
          <div class="card">
            <strong class="bad">Backend not connected yet</strong>
            <small>Once /api/match is deployed, your 3 provider matches will show here.</small>
            <div class="meta">
              Fix: update MATCH_API at top of this file to your Vercel URL and deploy backend.
            </div>
          </div>
        `;
        scrollToBottom();
        lockComposer(false);
        return;
      }

      // Ensure 3
      matches = matches.slice(0, 3);

      // Render results
      anim.innerHTML = `
        <div class="card">
          <strong>Top 3 matches</strong>
          <small>Based on your service, urgency, location, and budget</small>

          ${matches.map((m, idx) => `
            <div class="result">
              <div class="resultTop">
                <div class="resultName">${idx + 1}. ${escapeHtml(m.name || "Provider")}</div>
                <div class="resultBadge">⭐ ${escapeHtml(String(m.rating ?? "—"))}</div>
              </div>
              <div class="meta">
                <b>Price:</b> ${escapeHtml(m.price_range || "—")} ·
                <b>ETA:</b> ${escapeHtml(m.eta || "—")}
                <br>
                <b>Why:</b> ${escapeHtml(m.why || "Good fit for your request")}
              </div>
            </div>
          `).join("")}

          <div class="meta">
            <b>Summary:</b> ${escapeHtml(state.answers.service)} in ${escapeHtml(state.answers.zip)} ·
            ${escapeHtml(state.answers.urgency)} · ${escapeHtml(state.answers.budget)}
          </div>

          <a class="resultBadge" style="display:inline-block;margin-top:12px;text-decoration:none;color:var(--text)"
             href="processing.html">Continue →</a>
        </div>
      `;

      scrollToBottom();
      lockComposer(false);
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // =========================
    // FLOW
    // =========================
    async function start(){
      setProgress();
      await askAssistant("Hi — I’m MatchFlow. Answer a few quick questions and I’ll return 3 best options.");
      const q = currentQuestion();
      await askAssistant(q.text, q.type === "select" ? q.options : null);
      inputEl.focus();
    }

    async function handleSend(){
      const q = currentQuestion();
      const raw = inputEl.value;

      const result = validateAnswer(q, raw);
      if (!result.ok){
        if (raw.trim()) addBubble("user", raw.trim());
        inputEl.value = "";
        showInvalid(result.msg);
        return;
      }

      addBubble("user", result.value);
      inputEl.value = "";

      state.answers[q.key] = result.value;
      state.step++;

      if (state.step >= questions.length){
        setProgress();
        hintEl.textContent = "Matching…";
        await runMatching();
        return;
      }

      setProgress();
      const nq = currentQuestion();
      await askAssistant(nq.text, nq.type === "select" ? nq.options : null);
      hintEl.textContent = "Tip: tap chips for faster answers.";
    }

    document.getElementById("send").addEventListener("click", handleSend);
    document.getElementById("input").addEventListener("keydown", (e) => {
      if (e.key === "Enter") handleSend();
    });

    start();
  </script>
</body>
</html>